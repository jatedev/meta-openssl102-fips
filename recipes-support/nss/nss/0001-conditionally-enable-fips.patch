From f2cb8bcc556aa1121db7209d433170bd1ab60954 Mon Sep 17 00:00:00 2001
From: Hongxu Jia <hongxu.jia@windriver.com>
Date: Sat, 12 Oct 2019 10:49:28 +0800
Subject: [PATCH] conditionally enable fips

Add export NSS_FORCE_FIPS=1 to force enable fips, and add the same
macro limitaition to fips enable test, currently we are not ready
to support nss fips

...
$ certutil -N -d sql:. --empty-password
|certutil: function failed: SEC_ERROR_PKCS11_DEVICE_ERROR: A PKCS #11
module returned CKR_DEVICE_ERROR, indicating that a problem has occurred
with the token or slot.

$rpm -h
|error: Failed to initialize NSS library
...

Upstream-Status: Inappropriate [oe specific]

Signed-off-by: Hongxu Jia <hongxu.jia@windriver.com>
---
 nss/coreconf/config.mk       | 2 ++
 nss/lib/freebl/nsslowhash.c  | 2 +-
 nss/lib/pk11wrap/pk11util.c  | 2 +-
 nss/lib/sysinit/nsssysinit.c | 4 ++++
 4 files changed, 8 insertions(+), 2 deletions(-)

Index: nss-3.39/nss/coreconf/config.mk
===================================================================
--- nss-3.39.orig/nss/coreconf/config.mk
+++ nss-3.39/nss/coreconf/config.mk
@@ -179,6 +179,8 @@ endif
 # executing the startup tests at library load time.
 ifndef NSS_FORCE_FIPS
 DEFINES += -DNSS_NO_INIT_SUPPORT
+else
+DEFINES += -DNSS_FORCE_FIPS
 endif
 
 ifdef NSS_SEED_ONLY_DEV_URANDOM
Index: nss-3.39/nss/lib/freebl/nsslowhash.c
===================================================================
--- nss-3.39.orig/nss/lib/freebl/nsslowhash.c
+++ nss-3.39/nss/lib/freebl/nsslowhash.c
@@ -26,7 +26,7 @@ struct NSSLOWHASHContextStr {
 static int
 nsslow_GetFIPSEnabled(void)
 {
-#ifdef LINUX
+#if defined LINUX && defined NSS_FORCE_FIPS
     FILE *f;
     char d;
     size_t size;
Index: nss-3.39/nss/lib/sysinit/nsssysinit.c
===================================================================
--- nss-3.39.orig/nss/lib/sysinit/nsssysinit.c
+++ nss-3.39/nss/lib/sysinit/nsssysinit.c
@@ -151,6 +151,7 @@ getFIPSEnv(void)
 static PRBool
 getFIPSMode(void)
 {
+#ifdef NSS_FORCE_FIPS
     FILE *f;
     char d;
     size_t size;
@@ -169,6 +170,9 @@ getFIPSMode(void)
     if (d != '1')
         return PR_FALSE;
     return PR_TRUE;
+#else
+    return PR_FALSE;
+#endif
 }
 
 #else
